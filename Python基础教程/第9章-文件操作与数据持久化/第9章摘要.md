# **第九章 文件操作与数据持久化**

## 9.1 为什么需要文件操作？
在程序运行时，数据存储在内存中，但程序结束后这些数据就会丢失。文件操作允许我们将数据永久保存到硬盘中，实现数据的持久化存储。

## 9.2 文件的基本操作

### 9.2.1 打开文件
使用 `open()` 函数打开文件，基本语法如下：
```python
file = open('filename.txt', 'mode')
```

### 9.2.2 文件打开模式
| 模式 | 描述 |
|------|------|
| 'r'  | 只读模式（默认） |
| 'w'  | 写入模式，会覆盖原有内容 |
| 'a'  | 追加模式，在文件末尾添加内容 |
| 'x'  | 创建模式，文件不存在时创建 |
| 'b'  | 二进制模式（如 'rb', 'wb'） |
| 't'  | 文本模式（默认） |

### 9.2.3 读取文件内容
```python
# 方法1：读取整个文件
with open('example.txt', 'r', encoding='utf-8') as file:
    content = file.read()
    print(content)

# 方法2：逐行读取
with open('example.txt', 'r', encoding='utf-8') as file:
    for line in file:
        print(line.strip())  # strip() 去除换行符

# 方法3：读取为列表
with open('example.txt', 'r', encoding='utf-8') as file:
    lines = file.readlines()
    print(lines)
```

### 9.2.4 写入文件内容
```python
# 写入新文件（会覆盖原有内容）
with open('output.txt', 'w', encoding='utf-8') as file:
    file.write('Hello, World!\n')
    file.write('这是第二行\n')

# 追加内容
with open('output.txt', 'a', encoding='utf-8') as file:
    file.write('这是追加的内容\n')
```

### 9.2.5 使用 with 语句
`with` 语句可以自动管理文件资源，确保文件正确关闭：
```python
# 推荐写法：使用 with 语句
with open('example.txt', 'r') as file:
    content = file.read()
# 文件会自动关闭，不需要显式调用 file.close()
```

## 9.3 文件路径操作

### 9.3.1 使用 os 模块
```python
import os

# 获取当前工作目录
current_dir = os.getcwd()
print(f"当前目录: {current_dir}")

# 拼接路径（跨平台兼容）
file_path = os.path.join('folder', 'subfolder', 'file.txt')
print(f"文件路径: {file_path}")

# 检查路径是否存在
if os.path.exists('example.txt'):
    print("文件存在")
    
# 检查是否为文件或目录
if os.path.isfile('example.txt'):
    print("这是一个文件")
if os.path.isdir('folder'):
    print("这是一个目录")
```

### 9.3.2 目录操作
```python
import os

# 创建目录
os.mkdir('new_folder')  # 创建单个目录
os.makedirs('path/to/nested/folder', exist_ok=True)  # 创建多级目录

# 列出目录内容
files = os.listdir('.')  # 当前目录
print("目录内容:", files)

# 遍历目录树
for root, dirs, files in os.walk('.'):
    for file in files:
        print(os.path.join(root, file))
```

## 9.4 处理常见文件格式

### 9.4.1 CSV 文件处理
```python
import csv

# 读取 CSV 文件
with open('data.csv', 'r', encoding='utf-8') as file:
    reader = csv.reader(file)
    for row in reader:
        print(row)

# 写入 CSV 文件
data = [
    ['姓名', '年龄', '城市'],
    ['张三', '25', '北京'],
    ['李四', '30', '上海']
]

with open('output.csv', 'w', encoding='utf-8', newline='') as file:
    writer = csv.writer(file)
    writer.writerows(data)
```

### 9.4.2 JSON 文件处理
```python
import json

# 将 Python 对象写入 JSON 文件
data = {
    "name": "张三",
    "age": 25,
    "hobbies": ["读书", "编程", "音乐"],
    "married": False
}

with open('data.json', 'w', encoding='utf-8') as file:
    json.dump(data, file, ensure_ascii=False, indent=4)  # indent 使格式美观

# 从 JSON 文件读取
with open('data.json', 'r', encoding='utf-8') as file:
    loaded_data = json.load(file)
    print(loaded_data['name'])
```

## 9.5 数据持久化技术

### 9.5.1 使用 pickle 序列化
```python
import pickle

# 要保存的数据
my_data = {
    'name': '张三',
    'scores': [85, 92, 78],
    'passed': True
}

# 保存数据
with open('data.pkl', 'wb') as file:  # 注意是二进制写入模式
    pickle.dump(my_data, file)

# 加载数据
with open('data.pkl', 'rb') as file:  # 注意是二进制读取模式
    loaded_data = pickle.load(file)
    print(loaded_data)
```

### 9.5.2 使用 shelve 简单存储
```python
import shelve

# 写入数据
with shelve.open('mydata') as db:
    db['user1'] = {'name': '张三', 'age': 25}
    db['user2'] = {'name': '李四', 'age': 30}
    db['scores'] = [85, 92, 78]

# 读取数据
with shelve.open('mydata') as db:
    print(db['user1'])
    print(db.get('user3', '用户不存在'))  # 安全获取
```

### 9.5.3 SQLite 数据库基础
```python
import sqlite3

# 连接数据库（如果不存在则创建）
conn = sqlite3.connect('example.db')
cursor = conn.cursor()

# 创建表
cursor.execute('''
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    age INTEGER,
    email TEXT UNIQUE
)
''')

# 插入数据
cursor.execute("INSERT INTO users (name, age, email) VALUES (?, ?, ?)",
               ('张三', 25, 'zhangsan@example.com'))
cursor.execute("INSERT INTO users (name, age, email) VALUES (?, ?, ?)",
               ('李四', 30, 'lisi@example.com'))

# 查询数据
cursor.execute("SELECT * FROM users")
rows = cursor.fetchall()
for row in rows:
    print(f"ID: {row[0]}, 姓名: {row[1]}, 年龄: {row[2]}")

# 更新数据
cursor.execute("UPDATE users SET age = ? WHERE name = ?", (26, '张三'))

# 删除数据
cursor.execute("DELETE FROM users WHERE name = ?", ('李四',))

# 提交事务并关闭连接
conn.commit()
conn.close()
```

## 9.6 实战项目：简易学生成绩管理系统

### 9.6.1 系统功能
1. 添加学生信息
2. 查询学生成绩
3. 修改学生信息
4. 删除学生记录
5. 保存数据到文件

### 9.6.2 代码实现
```python
import json
import os

class StudentManager:
    def __init__(self, filename='students.json'):
        self.filename = filename
        self.students = self.load_data()
    
    def load_data(self):
        """从文件加载学生数据"""
        if os.path.exists(self.filename):
            with open(self.filename, 'r', encoding='utf-8') as file:
                return json.load(file)
        return []
    
    def save_data(self):
        """保存学生数据到文件"""
        with open(self.filename, 'w', encoding='utf-8') as file:
            json.dump(self.students, file, ensure_ascii=False, indent=2)
    
    def add_student(self):
        """添加学生"""
        name = input("请输入学生姓名: ")
        student_id = input("请输入学号: ")
        score = float(input("请输入成绩: "))
        
        student = {
            'name': name,
            'id': student_id,
            'score': score
        }
        
        self.students.append(student)
        self.save_data()
        print(f"学生 {name} 添加成功！")
    
    def show_all(self):
        """显示所有学生"""
        if not self.students:
            print("暂无学生信息")
            return
        
        print("\n=== 学生成绩列表 ===")
        for i, student in enumerate(self.students, 1):
            print(f"{i}. 姓名: {student['name']}, 学号: {student['id']}, 成绩: {student['score']}")
    
    def search_student(self):
        """查找学生"""
        keyword = input("请输入学生姓名或学号: ")
        
        found = []
        for student in self.students:
            if keyword in [student['name'], student['id']]:
                found.append(student)
        
        if found:
            print("\n=== 查找结果 ===")
            for student in found:
                print(f"姓名: {student['name']}, 学号: {student['id']}, 成绩: {student['score']}")
        else:
            print("未找到相关学生")
    
    def run(self):
        """运行主程序"""
        while True:
            print("\n=== 学生成绩管理系统 ===")
            print("1. 添加学生")
            print("2. 查看所有学生")
            print("3. 查找学生")
            print("4. 退出系统")
            
            choice = input("请选择操作 (1-4): ")
            
            if choice == '1':
                self.add_student()
            elif choice == '2':
                self.show_all()
            elif choice == '3':
                self.search_student()
            elif choice == '4':
                print("感谢使用，再见！")
                break
            else:
                print("输入错误，请重新选择")

# 运行系统
if __name__ == "__main__":
    manager = StudentManager()
    manager.run()
```

## 9.7 练习题

### 9.7.1 基础练习
1. **文件统计器**：编写一个程序，统计一个文本文件中：
   - 总字符数
   - 总单词数
   - 总行数
   - 每个单词的出现频率

2. **日志分析器**：读取一个日志文件，找出：
   - 错误日志的数量
   - 最频繁出现的错误类型
   - 按日期统计日志数量

### 9.7.2 进阶练习
1. **文件备份工具**：编写一个程序，可以：
   - 备份指定文件夹中的所有文件
   - 只备份修改过的文件（增量备份）
   - 将备份信息保存到数据库

2. **数据转换器**：编写一个程序，可以将：
   - CSV 文件转换为 JSON 格式
   - JSON 文件转换为 CSV 格式
   - 支持批量转换整个文件夹

## 9.8 本章小结

### 9.8.1 重点回顾
1. **文件操作基础**：打开、读取、写入、关闭文件
2. **路径管理**：使用 `os` 模块处理文件和目录路径
3. **文件格式处理**：CSV、JSON 等常见格式的读写
4. **数据持久化**：pickle、shelve、SQLite 等技术的使用

### 9.8.2 最佳实践
1. 总是使用 `with` 语句管理文件资源
2. 处理文件时指定正确的编码（尤其是中文）
3. 检查文件是否存在再进行操作
4. 使用参数化查询防止 SQL 注入
5. 定期备份重要数据

### 9.8.3 常见问题
1. **编码问题**：处理中文时使用 `encoding='utf-8'`
2. **路径问题**：使用 `os.path.join()` 保证跨平台兼容性
3. **文件锁问题**：避免多个程序同时写入同一文件
4. **内存问题**：处理大文件时使用分块读取

---

**学习建议**：文件操作是Python编程中的重要技能，建议多动手实践，尝试处理各种类型的文件。可以从简单的文本文件开始，逐步尝试CSV、JSON等格式，最后挑战数据库操作。记住：实践是最好的学习方法！